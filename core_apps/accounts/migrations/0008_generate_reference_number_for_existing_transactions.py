# Generated by Django 4.2.15 on 2025-09-20 15:09

from django.conf import settings
from django.db import migrations


def generate_reference_number(transaction_type):
    from core_apps.accounts.reference_utils import generate_transaction_reference

    return generate_transaction_reference(transaction_type)


def populate_reference_numbers(apps, schema_editor):
    Transaction = apps.get_model("accounts", "Transaction")

    # Get all transactions without reference numbers
    transactions = Transaction.objects.filter(reference_number__isnull=True)

    for transaction in transactions:
        # Generate a unique reference number
        max_attempts = 5
        for attempt in range(max_attempts):
            reference = generate_reference_number(transaction.transaction_type)

            # Check if reference already exists
            if not Transaction.objects.filter(reference_number=reference).exists():
                transaction.reference_number = reference
                transaction.save()
                break

            if attempt == max_attempts - 1:
                print(
                    f"Failed to generate unique reference for transaction {transaction.id}"
                )


class Migration(migrations.Migration):

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
        ("accounts", "0007_transaction_created_by_transaction_reference_number"),
    ]

    operations = [
        migrations.RunPython(populate_reference_numbers),
    ]
